
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agiota Control PRO v3.1</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-yellow-100 min-h-screen text-gray-800">
  <div class="max-w-2xl mx-auto p-4">
    <h1 class="text-3xl font-bold text-center text-red-600 mb-4">Agiota Control PRO</h1>

    <!-- LOGIN -->
    <div id="login" class="flex flex-col gap-2">
      <input type="password" id="senha" placeholder="Senha" class="p-2 border rounded">
      <button onclick="login()" class="bg-red-600 text-white py-2 rounded">Entrar</button>
    </div>

    <!-- MENU -->
    <div id="menu" class="hidden flex flex-col gap-2">
      <input id="capital" type="number" class="p-2 border rounded" placeholder="Capital Inicial" />
      <button onclick="mostrar('nova')" class="bg-yellow-500 py-2 rounded">Gerar Dívida</button>
      <button onclick="mostrar('devedores')" class="bg-yellow-400 py-2 rounded">Ver Devedores</button>
      <button onclick="logout()" class="bg-gray-400 py-2 rounded">Sair</button>
    </div>

    <!-- FORMULARIO -->
    <div id="nova" class="hidden mt-4">
      <h2 class="text-xl font-semibold mb-2">Nova Dívida</h2>
      <input id="nome" placeholder="Nome" class="p-2 border rounded w-full mb-1" />
      <input id="zap" placeholder="WhatsApp" class="p-2 border rounded w-full mb-1" />
      <input id="valor" placeholder="Valor (R$)" type="number" class="p-2 border rounded w-full mb-1" />
      <input id="juros" placeholder="Juros mensal (%)" type="number" class="p-2 border rounded w-full mb-1" />
      <input id="vencimento" placeholder="DD/MM/AAAA" class="p-2 border rounded w-full mb-1" />
      <input id="edit_index" type="hidden">
      <button onclick="salvarDivida()" class="bg-green-600 text-white w-full py-2 rounded">Salvar</button>
      <button onclick="limparFormulario()" class="mt-2 bg-gray-300 text-black w-full py-2 rounded">Limpar Formulário</button>
      <button onclick="mostrar('menu')" class="mt-2 bg-blue-200 py-2 rounded">Voltar ao Menu</button>
    </div>

    <!-- DEVEDORES -->
    <div id="devedores" class="hidden mt-4">
      <div class="flex justify-between mb-2">
        <input id="busca" class="p-2 border rounded w-1/2" placeholder="Buscar por nome..." oninput="renderDevedores()" />
        <select id="filtro" class="p-2 border rounded w-1/2" onchange="renderDevedores()">
          <option value="todos">Todos</option>
          <option value="pendentes">Pendentes</option>
          <option value="pagos">Pagos</option>
        </select>
      </div>
      <h2 class="text-xl font-semibold mb-2">Devedores</h2>
      <div id="lista" class="flex flex-col gap-3"></div>
      <button onclick="mostrar('menu')" class="mt-4 bg-blue-200 py-2 rounded">Voltar ao Menu</button>
    </div>
  </div>

  <script>
    const senhaCerta = "agiota123";
    let dados = JSON.parse(localStorage.getItem("devedores") || "[]");
    let capital = localStorage.getItem("capital") || "";

    function salvarBase() {
      localStorage.setItem("devedores", JSON.stringify(dados));
      localStorage.setItem("capital", document.getElementById("capital").value);
    }

    function login() {
      if (document.getElementById("senha").value === senhaCerta) {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("menu").classList.remove("hidden");
        document.getElementById("capital").value = capital;
      } else {
        alert("Senha incorreta.");
      }
    }

    function logout() {
      document.getElementById("login").classList.remove("hidden");
      document.getElementById("menu").classList.add("hidden");
      document.getElementById("nova").classList.add("hidden");
      document.getElementById("devedores").classList.add("hidden");
    }

    function mostrar(secao) {
      document.getElementById("nova").classList.add("hidden");
      document.getElementById("devedores").classList.add("hidden");
      if (secao === "nova") document.getElementById("nova").classList.remove("hidden");
      if (secao === "devedores") renderDevedores();
    }

    function parseDataBr(str) {
      const [d, m, y] = str.split("/");
      return new Date(`${y}-${m}-${d}`);
    }

    function calcularComJuros(valor, juros, vencimento) {
      const venc = parseDataBr(vencimento);
      const hoje = new Date();
      let meses = (hoje.getFullYear() - venc.getFullYear()) * 12 + (hoje.getMonth() - venc.getMonth());
      if (hoje.getDate() > venc.getDate()) meses += 1;
      meses = Math.max(0, meses);
      return (valor * (1 + juros / 100 * meses)).toFixed(2);
    }

    function salvarDivida() {
      const nome = document.getElementById("nome").value;
      const zap = document.getElementById("zap").value;
      const valor = parseFloat(document.getElementById("valor").value);
      const juros = parseFloat(document.getElementById("juros").value);
      const venc = document.getElementById("vencimento").value;
      const editIndex = document.getElementById("edit_index").value;

      if (!nome || !zap || isNaN(valor) || isNaN(juros) || !venc.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        alert("Preencha todos os campos corretamente.");
        return;
      }

      let dev = dados.find(d => d.nome === nome && d.zap === zap);
      if (!dev) {
        dev = { nome, zap, dividas: [] };
        dados.push(dev);
      }

      if (editIndex) {
        dev.dividas[parseInt(editIndex)] = { valor, juros, vencimento: venc, pago: false };
        document.getElementById("edit_index").value = "";
      } else {
        dev.dividas.push({ valor, juros, vencimento: venc, pago: false });
      }

      salvarBase();
      mostrar("devedores");
    }

    function limparFormulario() {
      ["nome", "zap", "valor", "juros", "vencimento", "edit_index"].forEach(id => document.getElementById(id).value = "");
    }

    function excluirDevedor(i) {
      if (confirm("Deseja excluir este devedor?")) {
        dados.splice(i, 1);
        salvarBase();
        renderDevedores();
      }
    }

    function pagar(i, j) {
      dados[i].dividas[j].pago = true;
      salvarBase();
      renderDevedores();
    }

    function cobrar(zap, nome, valor) {
      const tel = zap.replace(/\D/g, "");
      const texto = encodeURIComponent(`Olá ${nome}, sua dívida está em R$${valor}. Favor acertar.`);
      window.open(`https://wa.me/55${tel}?text=${texto}`, "_blank");
    }

    function editar(i, j) {
      const d = dados[i];
      const dv = d.dividas[j];
      document.getElementById("nome").value = d.nome;
      document.getElementById("zap").value = d.zap;
      document.getElementById("valor").value = dv.valor;
      document.getElementById("juros").value = dv.juros;
      document.getElementById("vencimento").value = dv.vencimento;
      document.getElementById("edit_index").value = j;
      mostrar("nova");
    }

    function renderDevedores() {
      document.getElementById("nova").classList.add("hidden");
      document.getElementById("devedores").classList.remove("hidden");

      const lista = document.getElementById("lista");
      const filtro = document.getElementById("filtro").value;
      const busca = document.getElementById("busca").value.toLowerCase();
      lista.innerHTML = "";

      dados.forEach((d, i) => {
        if (!d.nome.toLowerCase().includes(busca)) return;

        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow";

        let dividas = d.dividas;
        if (filtro === "pendentes") dividas = dividas.filter(dv => !dv.pago);
        if (filtro === "pagos") dividas = dividas.filter(dv => dv.pago);

        const total = dividas.reduce((acc, dv) => acc + parseFloat(calcularComJuros(dv.valor, dv.juros, dv.vencimento)), 0).toFixed(2);

        let html = `<div class="flex justify-between"><strong>${d.nome}</strong> <button onclick="excluirDevedor(${i})" class="text-red-600">Excluir</button></div>
        <div>Zap: ${d.zap}</div>
        <div class="mb-2">Total devido: R$ ${total}</div>`;

        dividas.forEach((dv, j) => {
          const valorFinal = calcularComJuros(dv.valor, dv.juros, dv.vencimento);
          html += `
            <hr class="my-2">
            <div>R$ ${dv.valor} → <b>R$ ${valorFinal}</b></div>
            <div>Venc: ${dv.vencimento} | Juros: ${dv.juros}%</div>
            ${dv.pago ? "<div class='text-green-600'>✔ Pago</div>" : ""}
            <div class="flex gap-2 mt-2">
              <button onclick="cobrar('${d.zap}','${d.nome}','${valorFinal}')" class="bg-yellow-400 px-2 py-1 rounded">Cobrar</button>
              ${!dv.pago ? `<button onclick="pagar(${i},${j})" class="bg-green-600 text-white px-2 py-1 rounded">Pagar</button>` : ""}
              <button onclick="editar(${i},${j})" class="bg-blue-500 text-white px-2 py-1 rounded">Editar</button>
            </div>`;
        });

        card.innerHTML = html;
        lista.appendChild(card);
      });
    }

   
  </script>
</body>
</html>
