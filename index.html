
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agiota Control PRO v3</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-yellow-100 min-h-screen text-gray-900">
  <div class="max-w-xl mx-auto p-4">
    <h1 class="text-3xl font-bold text-center text-red-600 mb-4">Agiota Control PRO</h1>

    <!-- Login -->
    <div id="login" class="flex flex-col gap-2">
      <input type="password" id="senha" placeholder="Senha" class="p-2 border rounded">
      <button onclick="login()" class="bg-red-600 text-white py-2 rounded">Entrar</button>
    </div>

    <!-- Menu -->
    <div id="menu" class="hidden flex flex-col gap-2">
      <button onclick="mostrar('nova')" class="bg-yellow-500 py-2 rounded">Gerar Dívida</button>
      <button onclick="mostrar('devedores')" class="bg-yellow-400 py-2 rounded">Ver Devedores</button>
      <button onclick="logout()" class="bg-gray-400 py-2 rounded">Sair</button>
    </div>

    <!-- Nova dívida -->
    <div id="nova" class="hidden mt-4">
      <h2 class="text-xl font-semibold mb-2">Nova Dívida</h2>
      <input id="nome" placeholder="Nome" class="p-2 border rounded w-full mb-1" />
      <input id="zap" placeholder="WhatsApp (ex: 11999999999)" class="p-2 border rounded w-full mb-1" />
      <input id="valor" placeholder="Valor (R$)" type="number" class="p-2 border rounded w-full mb-1" />
      <input id="juros" placeholder="Juros mensal (%)" type="number" class="p-2 border rounded w-full mb-1" />
      <input id="vencimento" placeholder="DD/MM/AAAA" class="p-2 border rounded w-full mb-2" />
      <input id="edit_index" type="hidden">
      <button onclick="salvarDivida()" class="bg-green-600 text-white w-full py-2 rounded">Salvar</button>
    </div>

    <!-- Lista de devedores -->
    <div id="devedores" class="hidden mt-4">
      <h2 class="text-xl font-semibold mb-2">Devedores</h2>
      <div id="lista" class="flex flex-col gap-3"></div>
    </div>
  </div>

  <script>
    const senhaCerta = "agiota123";
    let dados = JSON.parse(localStorage.getItem("devedores") || "[]");

    function salvarBase() {
      localStorage.setItem("devedores", JSON.stringify(dados));
    }

    function login() {
      const s = document.getElementById("senha").value;
      if (s === senhaCerta) {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("menu").classList.remove("hidden");
      } else {
        alert("Senha incorreta.");
      }
    }

    function logout() {
      document.getElementById("menu").classList.add("hidden");
      document.getElementById("nova").classList.add("hidden");
      document.getElementById("devedores").classList.add("hidden");
      document.getElementById("login").classList.remove("hidden");
    }

    function mostrar(secao) {
      document.getElementById("nova").classList.add("hidden");
      document.getElementById("devedores").classList.add("hidden");
      document.getElementById(secao).classList.remove("hidden");
      if (secao === "devedores") renderDevedores();
    }

    function parseDataBr(str) {
      const [d, m, y] = str.split("/");
      return new Date(`${y}-${m}-${d}`);
    }

    function calcularComJuros(valor, juros, vencimento) {
      const venc = parseDataBr(vencimento);
      const hoje = new Date();
      let meses = (hoje.getFullYear() - venc.getFullYear()) * 12 + (hoje.getMonth() - venc.getMonth());
      if (hoje.getDate() > venc.getDate()) meses += 1;
      meses = Math.max(0, meses);
      return (valor * (1 + juros / 100 * meses)).toFixed(2);
    }

    function salvarDivida() {
      const nome = document.getElementById("nome").value;
      const zap = document.getElementById("zap").value;
      const valor = parseFloat(document.getElementById("valor").value);
      const juros = parseFloat(document.getElementById("juros").value);
      const venc = document.getElementById("vencimento").value;
      const editIndex = document.getElementById("edit_index").value;

      if (!nome || !zap || isNaN(valor) || isNaN(juros) || !venc.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        alert("Preencha todos os campos corretamente.");
        return;
      }

      let devedor = dados.find(d => d.nome === nome && d.zap === zap);
      if (!devedor) {
        devedor = { nome, zap, dividas: [] };
        dados.push(devedor);
      }

      if (editIndex) {
        devedor.dividas[parseInt(editIndex)] = { valor, juros, vencimento: venc, pago: false };
        document.getElementById("edit_index").value = "";
      } else {
        devedor.dividas.push({ valor, juros, vencimento: venc, pago: false });
      }

      salvarBase();
      mostrar("devedores");
    }

    function renderDevedores() {
      const lista = document.getElementById("lista");
      lista.innerHTML = "";
      dados.forEach((d, i) => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded shadow";
        card.innerHTML = `<strong>${d.nome}</strong> (${d.zap})<br><br>` + d.dividas.map((dv, j) => {
          const total = calcularComJuros(dv.valor, dv.juros, dv.vencimento);
          return `
            <hr class="my-2">
            <div>R$ ${dv.valor} → <b>Total:</b> R$ ${total}</div>
            <div>Venc: ${dv.vencimento} | Juros: ${dv.juros}%</div>
            ${dv.pago ? "<div class='text-green-600'>✔ Pago</div>" : ""}
            <div class="flex gap-2 mt-2">
              <button onclick="cobrar('${d.zap}', '${d.nome}', '${total}')" class="bg-yellow-400 px-2 py-1 rounded">Zap</button>
              ${!dv.pago ? `<button onclick="pagar(${i},${j})" class="bg-green-500 text-white px-2 py-1 rounded">Pagar</button>` : ""}
              <button onclick="editar(${i},${j})" class="bg-blue-500 text-white px-2 py-1 rounded">Editar</button>
            </div>
          `;
        }).join("");
        lista.appendChild(card);
      });
    }

    function cobrar(zap, nome, valor) {
      const tel = zap.replace(/\D/g, "");
      const texto = encodeURIComponent(`Olá ${nome}, estou passando pra lembrar da dívida de R$${valor}.`);
      window.open(`https://wa.me/55${tel}?text=${texto}`, "_blank");
    }

    function pagar(i, j) {
      dados[i].dividas[j].pago = true;
      salvarBase();
      renderDevedores();
    }

    function editar(i, j) {
      const d = dados[i];
      const dv = d.dividas[j];
      document.getElementById("nome").value = d.nome;
      document.getElementById("zap").value = d.zap;
      document.getElementById("valor").value = dv.valor;
      document.getElementById("juros").value = dv.juros;
      document.getElementById("vencimento").value = dv.vencimento;
      document.getElementById("edit_index").value = j;
      mostrar("nova");
    }

    renderDevedores();
  </script>
</body>
</html>
